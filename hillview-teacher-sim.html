<!DOCTYPE html>
<html lang="en">
head>
  <meta charset="UTF-8" />
  <title>Hillview Middle School Teacher Simulator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Be a Hillview Middle School teacher for a year. Balance student scores, enrollment, and chaos across 10 key scenarios." />

  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-3THX5NYY2B"></script>
  <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-3THX5NYY2B');
  </script>

  <style>
    :root {
      color-scheme: dark;
      --bg: #020617;
      --card-bg: #020617;
      --card-border: rgba(148, 163, 184, 0.5);
      --accent: #22c55e;
      --accent-soft: rgba(34, 197, 94, 0.18);
      --text: #f9fafb;
      --muted: #9ca3af;
      --danger: #f97373;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background:
        radial-gradient(circle at top left, #1e293b 0, transparent 55%),
        radial-gradient(circle at top right, #111827 0, transparent 60%),
        var(--bg);
      color: var(--text);
      display: flex;
      justify-content: center;
      padding: 16px;
    }

    .app {
      max-width: 960px;
      width: 100%;
      background: rgba(2, 6, 23, 0.98);
      border-radius: 24px;
      padding: 20px 18px 18px;
      box-shadow:
        0 22px 45px rgba(0, 0, 0, 0.7),
        0 0 0 1px rgba(148, 163, 184, 0.22);
      backdrop-filter: blur(18px);
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }

    .title-group h1 {
      margin: 0;
      font-size: 1.6rem;
    }

    .title-group p {
      margin: 3px 0 0;
      font-size: 0.8rem;
      color: var(--muted);
    }

    .badge {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      border-radius: 999px;
      padding: 4px 10px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      color: var(--muted);
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(0, 2.1fr) minmax(0, 1.15fr);
      gap: 16px;
    }

    .panel {
      background: var(--card-bg);
      border-radius: 18px;
      border: 1px solid var(--card-border);
      padding: 13px 13px 12px;
    }

    .panel-header {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 8px;
    }

    .panel-title {
      font-size: 0.9rem;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      color: var(--muted);
    }

    .panel-subtitle {
      font-size: 0.75rem;
      color: var(--muted);
    }

    .start-screen {
      display: flex;
      gap: 16px;
      flex-direction: column;
    }

    .start-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
    }

    label {
      font-size: 0.82rem;
      color: var(--muted);
    }

    select {
      background: #020617;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      padding: 6px 10px;
      color: var(--text);
      font-size: 0.9rem;
      outline: none;
    }

    select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.6);
    }

    .primary-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      border-radius: 999px;
      border: none;
      padding: 8px 16px;
      font-weight: 600;
      font-size: 0.87rem;
      cursor: pointer;
      background: linear-gradient(135deg, var(--accent), #16a34a);
      color: #01110a;
      box-shadow: 0 14px 26px rgba(34, 197, 94, 0.45);
      transition: transform 0.08s ease-out, box-shadow 0.08s ease-out;
    }

    .primary-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 18px 34px rgba(34, 197, 94, 0.55);
    }

    .primary-btn:active {
      transform: translateY(0);
      box-shadow: 0 10px 18px rgba(34, 197, 94, 0.4);
    }

    .primary-btn[disabled] {
      opacity: 0.5;
      cursor: default;
      transform: none;
      box-shadow: none;
    }

    .muted-btn {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      padding: 5px 10px;
      font-size: 0.78rem;
      background: transparent;
      color: var(--muted);
      cursor: pointer;
    }

    .scenario-body {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .scenario-meta {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
      font-size: 0.78rem;
      color: var(--muted);
    }

    .pill-soft {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 3px 9px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.9);
      font-size: 0.75rem;
      color: var(--muted);
    }

    .scenario-text {
      font-size: 0.9rem;
      line-height: 1.5;
      padding: 10px 10px 8px;
      border-radius: 14px;
      background: radial-gradient(circle at top left, #0b1120, #020617);
      border: 1px solid rgba(148, 163, 184, 0.35);
    }

    .options {
      margin-top: 4px;
      display: grid;
      grid-template-columns: 1fr;
      gap: 6px;
    }

    .option-btn {
      width: 100%;
      text-align: left;
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.92);
      padding: 7px 9px;
      font-size: 0.87rem;
      color: #e5e7eb;
      cursor: pointer;
      transition: background 0.09s ease-out, transform 0.05s ease-out, box-shadow 0.09s ease-out, border-color 0.09s ease-out;
    }

    .option-btn:hover {
      background: rgba(30, 64, 175, 0.55);
      box-shadow: 0 8px 16px rgba(30, 64, 175, 0.45);
    }

    .option-btn.selected {
      border-color: var(--accent);
      background: radial-gradient(circle at top left, var(--accent-soft), rgba(15, 23, 42, 0.98));
      box-shadow: 0 10px 18px rgba(34, 197, 94, 0.35);
    }

    .custom-response {
      margin-top: 8px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .custom-response textarea {
      resize: vertical;
      min-height: 60px;
      max-height: 160px;
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: #020617;
      color: var(--text);
      padding: 8px 9px;
      font-size: 0.85rem;
      outline: none;
    }

    .custom-response textarea:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.7);
    }

    .custom-hint {
      font-size: 0.72rem;
      color: var(--muted);
    }

    .scenario-footer {
      margin-top: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .scenario-footer-left {
      font-size: 0.78rem;
      color: var(--muted);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 8px;
    }

    .stat-block {
      background: radial-gradient(circle at top left, #020617, #020617);
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      padding: 8px 9px 9px;
      font-size: 0.78rem;
    }

    .stat-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 4px;
      gap: 6px;
    }

    .stat-label {
      color: var(--muted);
      font-size: 0.78rem;
    }

    .stat-value {
      font-weight: 600;
      font-size: 0.9rem;
    }

    .stat-bar {
      position: relative;
      width: 100%;
      height: 7px;
      border-radius: 999px;
      background: #020617;
      overflow: hidden;
    }

    .stat-bar-fill {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      border-radius: inherit;
      background: linear-gradient(90deg, var(--accent), #22c55e);
      transition: width 0.25s ease-out;
    }

    .stat-extra {
      margin-top: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.72rem;
      color: var(--muted);
    }

    .log {
      margin-top: 6px;
      max-height: 136px;
      overflow-y: auto;
      padding-right: 4px;
      font-size: 0.76rem;
      color: var(--muted);
    }

    .log-item {
      margin-bottom: 4px;
    }

    .log-item strong {
      color: #e5e7eb;
      font-weight: 500;
    }

    .end-screen {
      display: none;
      flex-direction: column;
      gap: 10px;
      padding: 10px 9px;
      border-radius: 14px;
      background: radial-gradient(circle at top left, #0b1120, #020617);
      border: 1px solid rgba(148, 163, 184, 0.5);
      margin-top: 6px;
      font-size: 0.85rem;
    }

    .end-title {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .end-rank {
      font-size: 0.95rem;
      font-weight: 600;
      margin-bottom: 2px;
    }

    .end-metric-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px 12px;
      font-size: 0.8rem;
    }

    .end-footnote {
      font-size: 0.75rem;
      color: var(--muted);
    }

    .error-text {
      color: var(--danger);
      font-size: 0.76rem;
    }

    @media (max-width: 800px) {
      .layout {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 600px) {
      .app {
        padding: 16px 12px 14px;
        border-radius: 18px;
      }
      header {
        flex-direction: column;
        align-items: flex-start;
      }
      .title-group h1 {
        font-size: 1.3rem;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="title-group">
        <h1>Hillview Middle School Teacher Simulator</h1>
        <p>Ten big moments from August to June. Can you keep your score up and your class intact?</p>
      </div>
      <div class="badge">Hillview Â· Menlo Park</div>
    </header>

    <div class="layout">
      <!-- Left: Scenario / Start / End -->
      <section class="panel" id="scenario-panel">
        <div class="panel-header">
          <div>
            <div class="panel-title" id="panel-title-label">Setup</div>
            <div class="panel-subtitle" id="panel-subtitle-label">
              Choose your class size and start the school year at 50 / 100.
            </div>
          </div>
          <button class="muted-btn" id="restart-btn" style="display:none;">Restart year</button>
        </div>

        <div id="start-screen" class="start-screen">
          <div>
            <p style="margin:0 0 8px;font-size:0.9rem;">
              You&rsquo;re a Hillview teacher for one school year. Ten key moments will test your choices.
            </p>
            <p style="margin:0;font-size:0.82rem;color:var(--muted);">
              Your <strong>Score</strong> starts at 50 / 100. It can swing hard up or down.
              You also track <strong>students remaining in your class</strong>.
            </p>
          </div>

          <div class="start-row">
            <label for="class-size">Class size:</label>
            <select id="class-size">
              <option value="16">16 students (almost chill)</option>
              <option value="22" selected>22 students (realistic)</option>
              <option value="28">28 students (crowded)</option>
              <option value="32">32 students (dungeon mode)</option>
              <option value="36">36 students (why would you do this)</option>
            </select>
          </div>

          <div class="start-row">
            <label>School year:</label>
            <span style="font-size:0.85rem;">10 scenarios from August to June</span>
          </div>

          <div class="start-row">
            <button class="primary-btn" id="start-btn">
              Start school year
              <span>â–¶</span>
            </button>
          </div>
        </div>

        <div id="scenario-container" style="display:none;">
          <div class="scenario-body">
            <div class="scenario-meta">
              <div>
                <span id="round-label">Scenario 1 of 10</span>
              </div>
              <div class="pill-soft">
                <span id="class-meta-text">22 students Â· Normal difficulty</span>
              </div>
            </div>

            <div class="scenario-text">
              <div id="scenario-text"></div>
            </div>

            <div class="options" id="options-container"></div>

            <div class="custom-response">
              <label for="custom-input">Or write your own response:</label>
              <textarea id="custom-input" placeholder="Type what you&rsquo;d actually do or say here..."></textarea>
              <div class="custom-hint">
                Tip: Explain your plan clearly. Structure + empathy + reflection usually score well.
              </div>
            </div>

            <div class="scenario-footer">
              <div class="scenario-footer-left">
                <span id="feedback-text">Pick an option or write your own response.</span>
              </div>
              <div>
                <button class="primary-btn" id="submit-btn">
                  Submit &amp; see outcome
                </button>
              </div>
            </div>
          </div>

          <div id="end-screen" class="end-screen">
            <div class="end-title">Year Complete &mdash; Teacher Report</div>
            <div class="end-rank" id="end-rank"></div>
            <div class="end-metric-row" id="end-metrics"></div>
            <div class="end-footnote" id="end-footnote"></div>
            <div>
              <button class="primary-btn" id="play-again-btn">Teach another year</button>
            </div>
          </div>
        </div>
      </section>

      <!-- Right: Stats / Log -->
      <aside class="panel">
        <div class="panel-header">
          <div>
            <div class="panel-title">Class Status</div>
            <div class="panel-subtitle">
              Track your score, enrollment, and how the year unfolds.
            </div>
          </div>
        </div>

        <div class="stats-grid">
          <!-- Overall score -->
          <div class="stat-block">
            <div class="stat-header">
              <div class="stat-label">Overall Score</div>
              <div class="stat-value" id="score-value">50 / 100</div>
            </div>
            <div class="stat-bar">
              <div class="stat-bar-fill" id="score-bar" style="width:50%;"></div>
            </div>
            <div class="stat-extra">
              <span id="score-trend">Game not started yet.</span>
              <span>Starts at 50. 0 = disaster, 100 = legend.</span>
            </div>
          </div>

          <!-- Students remaining -->
          <div class="stat-block">
            <div class="stat-header">
              <div class="stat-label">Students Remaining</div>
              <div class="stat-value" id="students-value">0</div>
            </div>
            <div class="stat-extra">
              <span id="students-trend">No changes yet.</span>
              <span id="students-cap-note"></span>
            </div>
          </div>

          <!-- Progress + log -->
          <div class="stat-block">
            <div class="stat-header">
              <div class="stat-label">Year Progress</div>
              <div class="stat-value" id="progress-value">0 / 10</div>
            </div>
            <div class="stat-extra">
              <span id="difficulty-label">Difficulty: Normal</span>
              <span id="round-mini-label">Scenario 0 of 10</span>
            </div>
            <div class="log" id="log-container"></div>
          </div>
        </div>
      </aside>
    </div>
  </div>

  <script>
    // ===============================
    // Core config
    // ===============================
    const TOTAL_ROUNDS = 10;
    const SCORE_MIN = 0;
    const SCORE_MAX = 100;
    const SCORE_START = 50;

    const scenarios = [
      {
        id: "phones",
        label: "Phone Problem",
        prompt: "In the middle of group work, a cluster of students is texting and filming a TikTok. Others are watching instead of working. One kid says, â€œYou never care about phones anyway.â€",
        options: [
          {
            text: "Collect every phone and announce zero tolerance for the rest of the term.",
            scoreImpact: 4,
            nuance: "Clear boundary, but feels sudden and strict."
          },
          {
            text: "Ignore it and hope the group gets back on task.",
            scoreImpact: -4,
            nuance: "Short-term calm, long-term loss of authority."
          },
          {
            text: "Pause, restate phone rules, give a warning, and apply small consequences if it continues.",
            scoreImpact: 7,
            nuance: "Balances structure and fairness if you follow through."
          },
          {
            text: "Stop the class and have students create fair phone rules, then vote and adopt them.",
            scoreImpact: 6,
            nuance: "High buy-in, but you burn instructional time."
          }
        ]
      },
      {
        id: "late_work",
        label: "Late Work Pile",
        prompt: "End of trimester: chronic missing-work students bring huge stacks of late assignments. On-time students ask for extra credit. Everyone wants a deal.",
        options: [
          {
            text: "Accept all late work for full credit and move on.",
            scoreImpact: 1,
            nuance: "Reduces stress but undermines deadlines."
          },
          {
            text: "Refuse all late work. Deadlines are fixed.",
            scoreImpact: -5,
            nuance: "Sends a message but can feel unfair and rigid."
          },
          {
            text: "Take late work for partial credit plus a short reflection on planning.",
            scoreImpact: 7,
            nuance: "Teaches responsibility and still honors effort."
          },
          {
            text: "Hold one â€œamnesty dayâ€ where everyone can revise or turn in missing work up to a grade cap.",
            scoreImpact: 6,
            nuance: "Boosts learning and hope, but increases grading load."
          }
        ]
      },
      {
        id: "parent_email",
        label: "Spicy Parent Email",
        prompt: "A long email claims youâ€™re â€œtargetingâ€ a student and CCs admin and counselor. You remember events differently. The parent wants an immediate explanation.",
        options: [
          {
            text: "Reply right away with a detailed defense of every decision.",
            scoreImpact: -2,
            nuance: "May escalate and sound defensive."
          },
          {
            text: "Wait several days to respond so things cool off.",
            scoreImpact: -3,
            nuance: "Feels unresponsive and can erode trust."
          },
          {
            text: "Acknowledge concerns and propose a meeting with you, the student, and counselor.",
            scoreImpact: 7,
            nuance: "Collaborative and student-centered."
          },
          {
            text: "Forward it to your admin and ask them to handle it.",
            scoreImpact: 2,
            nuance: "Protects your time but distances you from the family relationship."
          }
        ]
      },
      {
        id: "group_project",
        label: "Group Project Drama",
        prompt: "One student says theyâ€™re doing all the work. Another group has two strong voices drowning everyone out. Presentations are next week.",
        options: [
          {
            text: "Tell groups to work it out on their own.",
            scoreImpact: -3,
            nuance: "Some will, many wonâ€™t. Quiet kids lose out."
          },
          {
            text: "Reshuffle groups into more balanced teams.",
            scoreImpact: 3,
            nuance: "Can help, but disrupts existing dynamics."
          },
          {
            text: "Use private peer evaluations that affect individual grades and meet briefly with struggling groups.",
            scoreImpact: 8,
            nuance: "High accountability and support, extra work for you."
          },
          {
            text: "Teach quick norms for group roles, then offer optional conflict-mediation time during work.",
            scoreImpact: 6,
            nuance: "Builds skills and helps many groups stabilize."
          }
        ]
      },
      {
        id: "sub_plan",
        label: "Sub Plans While Sick",
        prompt: "Youâ€™ll be out two days mid-unit. You can leave easy work for the sub or push to keep the unit going without you.",
        options: [
          {
            text: "Leave simple worksheets and a low-stress activity.",
            scoreImpact: 1,
            nuance: "Protects the sub and kids, but you lose momentum."
          },
          {
            text: "Write detailed plans and expect full lessons to run.",
            scoreImpact: 4,
            nuance: "Some learning continues, but execution is shaky."
          },
          {
            text: "Assign a clear independent project that extends recent learning.",
            scoreImpact: 7,
            nuance: "Keeps kids thinking with manageable structure."
          },
          {
            text: "Record quick lesson videos and post guided notes with check-in questions.",
            scoreImpact: 8,
            nuance: "High continuity for students, high effort while sick."
          }
        ]
      },
      {
        id: "behavior",
        label: "Escalating Comments",
        prompt: "Two students start trading personal digs during discussion. One looks ready to cry. The room is getting spicy.",
        options: [
          {
            text: "Call them out publicly and demand they apologize.",
            scoreImpact: -1,
            nuance: "May stop it, but adds shame and doesnâ€™t teach skills."
          },
          {
            text: "Ignore it and keep the lesson moving.",
            scoreImpact: -6,
            nuance: "Targeted student feels unsafe; climate suffers."
          },
          {
            text: "Pause, name what you see, reset respect norms, and check in privately with both students later.",
            scoreImpact: 8,
            nuance: "Protects safety and relationships."
          },
          {
            text: "Send both students to the office immediately.",
            scoreImpact: 1,
            nuance: "Short-term control, little long-term learning."
          }
        ]
      },
      {
        id: "grading",
        label: "Big Test Results",
        prompt: "Major assessment scores come back: some very low, some nearly perfect. Students are buzzing about fairness and grades.",
        options: [
          {
            text: "Curve scores so most land near a B and move on.",
            scoreImpact: 2,
            nuance: "Short-term relief, blurry feedback signal."
          },
          {
            text: "Keep scores as-is with no retakes or corrections.",
            scoreImpact: -2,
            nuance: "Clear line, but limited chance to grow."
          },
          {
            text: "Offer corrections or retakes that require explaining mistakes and showing new understanding.",
            scoreImpact: 8,
            nuance: "Strong for learning, more grading for you."
          },
          {
            text: "Explain the purpose of the assessment and offer help sessions for anyone who wants support.",
            scoreImpact: 6,
            nuance: "Adds clarity and support; not all will attend."
          }
        ]
      },
      {
        id: "quiet_student",
        label: "The Quiet Student",
        prompt: "A student almost never speaks in discussion but writes thoughtful work. Group mates often talk over them.",
        options: [
          {
            text: "Cold-call them more so they â€œget used toâ€ speaking.",
            scoreImpact: -2,
            nuance: "Can raise anxiety and harm trust."
          },
          {
            text: "Ignore it. Their written work is fine.",
            scoreImpact: 0,
            nuance: "Safe, but misses growth opportunity."
          },
          {
            text: "Check in privately, offer options (chat posts, small groups, written contributions), and slowly build their voice.",
            scoreImpact: 7,
            nuance: "Respects their needs and expands participation."
          },
          {
            text: "Make them discussion leader for a day.",
            scoreImpact: 2,
            nuance: "Works for some, but can feel like a forced spotlight."
          }
        ]
      },
      {
        id: "homework",
        label: "Homework Complaints",
        prompt: "Students say homework is â€œpointlessâ€ and theyâ€™re overloaded with activities. Your homework policy is fuzzy.",
        options: [
          {
            text: "Drop homework completely and keep all practice in class.",
            scoreImpact: 2,
            nuance: "Kids cheer, but some lose extra practice."
          },
          {
            text: "Assign more homework to build grit.",
            scoreImpact: -5,
            nuance: "May help a few; burns many out."
          },
          {
            text: "Set a clear, short weekly homework plan that directly supports upcoming lessons.",
            scoreImpact: 7,
            nuance: "Predictable, purposeful workload."
          },
          {
            text: "Make all homework optional challenge work with no penalty.",
            scoreImpact: 4,
            nuance: "Great for highly motivated kids, less help for strugglers."
          }
        ]
      },
      {
        id: "identity",
        label: "Hurtful Joke",
        prompt: "A student makes a joke about another studentâ€™s background that crosses into stereotype territory. Some laugh; the targeted student goes quiet.",
        options: [
          {
            text: "Brush it off as â€œkids being kidsâ€ and keep going.",
            scoreImpact: -8,
            nuance: "Signals that harmful jokes are tolerated."
          },
          {
            text: "Scold the student publicly and give detention.",
            scoreImpact: -1,
            nuance: "Shows the line matters but doesnâ€™t teach much."
          },
          {
            text: "Pause, name why the comment isnâ€™t okay, center impact over intent, and reset norms briefly.",
            scoreImpact: 8,
            nuance: "Models inclusive community in real time."
          },
          {
            text: "Address it privately with the student who joked and check in with the student targeted.",
            scoreImpact: 6,
            nuance: "Supports both students; less whole-class learning."
          }
        ]
      }
    ];

    // ===============================
    // Game state
    // ===============================
    const state = {
      classSize: 22,
      studentsRemaining: 22,
      maxStudents: 22,
      difficultyMultiplier: 1,
      round: 0,
      maxRounds: TOTAL_ROUNDS,
      score: SCORE_START,
      lastScoreDelta: 0,
      lastStudentsDelta: 0,
      history: [],
      shuffledScenarios: [],
      currentScenario: null
    };

    // ===============================
    // DOM refs
    // ===============================
    const startScreen = document.getElementById("start-screen");
    const scenarioContainer = document.getElementById("scenario-container");
    const restartBtn = document.getElementById("restart-btn");
    const startBtn = document.getElementById("start-btn");
    const submitBtn = document.getElementById("submit-btn");
    const playAgainBtn = document.getElementById("play-again-btn");

    const classSizeSelect = document.getElementById("class-size");
    const scenarioTextEl = document.getElementById("scenario-text");
    const optionsContainer = document.getElementById("options-container");
    const customInput = document.getElementById("custom-input");
    const feedbackText = document.getElementById("feedback-text");

    const roundLabel = document.getElementById("round-label");
    const roundMiniLabel = document.getElementById("round-mini-label");
    const classMetaText = document.getElementById("class-meta-text");
    const difficultyLabel = document.getElementById("difficulty-label");

    const panelTitleLabel = document.getElementById("panel-title-label");
    const panelSubtitleLabel = document.getElementById("panel-subtitle-label");

    const scoreValue = document.getElementById("score-value");
    const scoreBar = document.getElementById("score-bar");
    const scoreTrend = document.getElementById("score-trend");

    const studentsValue = document.getElementById("students-value");
    const studentsTrend = document.getElementById("students-trend");
    const studentsCapNote = document.getElementById("students-cap-note");

    const progressValue = document.getElementById("progress-value");
    const logContainer = document.getElementById("log-container");

    const endScreen = document.getElementById("end-screen");
    const endRank = document.getElementById("end-rank");
    const endMetrics = document.getElementById("end-metrics");
    const endFootnote = document.getElementById("end-footnote");

    // ===============================
    // Helpers
    // ===============================
    function shuffleArray(arr) {
      const copy = arr.slice();
      for (let i = copy.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [copy[i], copy[j]] = [copy[j], copy[i]];
      }
      return copy;
    }

    function clamp(num, min, max) {
      return Math.max(min, Math.min(max, num));
    }

    function computeDifficultyFromClassSize(size) {
      // 16 -> ~0.85, 36 -> ~1.35
      return 0.85 + (size - 16) * 0.025;
    }

    function difficultyLabelFromMultiplier(mult) {
      if (mult <= 0.95) return "Difficulty: Chill";
      if (mult <= 1.05) return "Difficulty: Normal";
      if (mult <= 1.15) return "Difficulty: Busy";
      if (mult <= 1.25) return "Difficulty: Crowded";
      return "Difficulty: Legendary";
    }

    function formatScoreTrend(delta) {
      if (delta > 12) return `Last move: â–² huge gain (+${delta})`;
      if (delta > 5) return `Last move: â–² strong gain (+${delta})`;
      if (delta > 0) return `Last move: â–² small gain (+${delta})`;
      if (delta === 0) return "Last move: â–¬ no major change";
      if (delta < -12) return `Last move: â–¼ huge drop (${delta})`;
      if (delta < -5) return `Last move: â–¼ strong drop (${delta})`;
      return `Last move: â–¼ small drop (${delta})`;
    }

    function formatStudentTrend(delta) {
      if (delta > 2) return `Enrollment spike: +${delta} students joined.`;
      if (delta > 0) return `Small gain: +${delta} student joined.`;
      if (delta === 0) return "No enrollment change.";
      if (delta < -2) return `${-delta} students left your class. Rough day.`;
      return `${-delta} student left your class.`;
    }

    // ===============================
    // Fake "LLM" text + scoring
    // ===============================
    function fakeLLMGenerateScenarioText(baseScenario) {
      return baseScenario.prompt;
    }

    function analyzeCustomResponse(text) {
      const lower = text.toLowerCase();
      let baseDelta = 0;
      let explanationPieces = [];

      // Hard safety clamp for catastrophic answers
      const catastrophicWords = ["fire", "burn", "arson", "kill", "hit", "punch", "violence", "explode"];
      const containsCatastrophic = catastrophicWords.some(w => lower.includes(w));

      if (containsCatastrophic) {
        return {
          baseDelta: -30,
          catastrophic: true,
          explanation:
            "This response is extremely unsafe and would never be acceptable in a real classroom. Students and families would demand immediate action."
        };
      }

      const structureWords = ["expectation", "routine", "clear rule", "rules", "plan", "structure", "boundaries", "consequence"];
      const empathyWords = ["listen", "hear you", "understand", "feel", "check in", "together", "safe", "support"];
      const reflectionWords = ["reflect", "reflection", "why it happened", "next time", "improve", "plan ahead"];
      const repairWords = ["apologize", "restore", "repair", "make it right"];
      const punitiveWords = ["detention", "punish", "zero", "automatic fail", "embarrass", "call you out"];
      const vagueWords = ["idk", "no idea", "whatever", "don't care", "do nothing"];

      function countMatches(words) {
        return words.reduce((count, w) => (lower.includes(w) ? count + 1 : count), 0);
      }

      const sCount = countMatches(structureWords);
      const eCount = countMatches(empathyWords);
      const rCount = countMatches(reflectionWords);
      const repCount = countMatches(repairWords);
      const pCount = countMatches(punitiveWords);
      const vCount = countMatches(vagueWords);

      baseDelta += sCount * 2;
      if (sCount > 0) explanationPieces.push("You named clear expectations or routines.");

      baseDelta += eCount * 3;
      if (eCount > 0) explanationPieces.push("You showed empathy and tried to hear students.");

      baseDelta += rCount * 3;
      if (rCount > 0) explanationPieces.push("You built in reflection and future planning.");

      baseDelta += repCount * 2;
      if (repCount > 0) explanationPieces.push("You included repair or making things right.");

      baseDelta -= pCount * 2;
      if (pCount > 0) explanationPieces.push("You leaned on punishment, which can backfire if itâ€™s not paired with support.");

      baseDelta -= vCount * 3;
      if (vCount > 0) explanationPieces.push("You sounded vague or checked out, which students feel quickly.");

      if (lower.includes("hillview")) {
        baseDelta += 1;
      }

      if (text.length < 10) {
        baseDelta -= 3;
        explanationPieces.push("Your answer was very short, so it doesnâ€™t show much of a plan.");
      } else if (text.length > 400) {
        baseDelta -= 2;
        explanationPieces.push("Your answer is long; tight, clear explanations are easier for students to follow.");
      }

      baseDelta = clamp(baseDelta, -15, 15);

      let explanation = "";
      if (explanationPieces.length) {
        explanation = explanationPieces.join(" ");
      } else if (baseDelta > 0) {
        explanation = "Your response sounds generally thoughtful, with some structure and care.";
      } else if (baseDelta < 0) {
        explanation = "Your response raises concerns about clarity, fairness, or emotional safety.";
      } else {
        explanation = "Your response is pretty neutral and doesnâ€™t dramatically help or hurt.";
      }

      return { baseDelta, catastrophic: false, explanation };
    }

    function evaluateDecision({ scenario, choiceIndex, customText }) {
      let baseDelta = 0;
      let explanation = "";
      let catastrophic = false;

      if (choiceIndex !== null) {
        const opt = scenario.options[choiceIndex];
        baseDelta = opt.scoreImpact;
        explanation = opt.nuance;
      } else {
        const analysis = analyzeCustomResponse(customText);
        baseDelta = analysis.baseDelta;
        explanation = analysis.explanation;
        catastrophic = analysis.catastrophic;
      }

      // Scale by difficulty (bigger classes = more sensitive)
      const scaled = baseDelta / state.difficultyMultiplier;

      // Random wiggle for flavor
      const wiggle = Math.floor(Math.random() * 5) - 2; // -2..+2
      let finalDelta = Math.round(scaled + wiggle);

      if (catastrophic) {
        finalDelta = Math.min(finalDelta, -20);
      } else {
        finalDelta = clamp(finalDelta, -18, 18);
      }

      // Students gained/lost based on how big the move is
      let studentsDelta = 0;
      if (finalDelta <= -15) {
        studentsDelta = -5;
      } else if (finalDelta <= -10) {
        studentsDelta = -3;
      } else if (finalDelta <= -5) {
        studentsDelta = -1;
      } else if (finalDelta >= 12) {
        studentsDelta = 2;
      } else if (finalDelta >= 6) {
        studentsDelta = 1;
      }

      return { scoreDelta: finalDelta, studentsDelta, explanation, catastrophic };
    }

    function buildCommentary(scoreDelta, explanation, catastrophic) {
      let lead;
      if (catastrophic) {
        lead =
          "This decision would be a major crisis in a real school. Safety and professionalism would be the top concern.";
      } else if (scoreDelta >= 12) {
        lead = "Huge win. Kids learn a lot and the community sees you as a rockstar.";
      } else if (scoreDelta >= 6) {
        lead = "Strong move. You balanced clarity and care in a way that mostly works.";
      } else if (scoreDelta >= 2) {
        lead = "Decent choice. Helpful overall, with a few trade-offs.";
      } else if (scoreDelta > -2) {
        lead = "Pretty neutral. It doesnâ€™t change much, good or bad.";
      } else if (scoreDelta > -8) {
        lead = "This has real costs. Some students will feel less supported or less clear on expectations.";
      } else {
        lead = "Tough outcome. Studentsâ€™ trust, safety, or actual learning would take a big hit.";
      }

      return `${lead} ${explanation}`;
    }

    // ===============================
    // UI updates
    // ===============================
    function updateStatsUI() {
      scoreValue.textContent = `${state.score} / ${SCORE_MAX}`;
      scoreBar.style.width = `${(state.score / SCORE_MAX) * 100}%`;
      scoreTrend.textContent =
        state.round === 0 ? "Game not started yet." : formatScoreTrend(state.lastScoreDelta);

      studentsValue.textContent = state.studentsRemaining;
      studentsTrend.textContent =
        state.round === 0 ? "No changes yet." : formatStudentTrend(state.lastStudentsDelta);
      studentsCapNote.textContent = `Started with ${state.classSize}. Max so far: ${state.maxStudents}.`;

      progressValue.textContent = `${state.round} / ${state.maxRounds}`;
      roundMiniLabel.textContent = `Scenario ${state.round} of ${state.maxRounds}`;
      difficultyLabel.textContent = difficultyLabelFromMultiplier(state.difficultyMultiplier);
    }

    function appendLogEntry(entry) {
      const div = document.createElement("div");
      div.className = "log-item";
      div.innerHTML = `<strong>Scenario ${entry.round}:</strong> ${entry.summary}`;
      logContainer.appendChild(div);
      logContainer.scrollTop = logContainer.scrollHeight;
    }

    function renderScenario() {
      const scenario = state.currentScenario;
      if (!scenario) return;

      roundLabel.textContent = `Scenario ${state.round} of ${state.maxRounds}`;
      scenarioTextEl.textContent = fakeLLMGenerateScenarioText(scenario);

      optionsContainer.innerHTML = "";
      scenario.options.forEach((opt, index) => {
        const btn = document.createElement("button");
        btn.className = "option-btn";
        btn.textContent = opt.text;
        btn.dataset.index = String(index);
        btn.addEventListener("click", () => {
          document.querySelectorAll(".option-btn").forEach(b => b.classList.remove("selected"));
          btn.classList.add("selected");
          feedbackText.textContent =
            "Option selected. You can still add or edit a custom response before submitting.";
          feedbackText.classList.remove("error-text");
        });
        optionsContainer.appendChild(btn);
      });

      customInput.value = "";
      feedbackText.textContent = "Pick an option or write your own response.";
      feedbackText.classList.remove("error-text");
    }

    function showStartScreen() {
      startScreen.style.display = "flex";
      scenarioContainer.style.display = "none";
      restartBtn.style.display = "none";
      panelTitleLabel.textContent = "Setup";
      panelSubtitleLabel.textContent = "Choose your class size and start the year at 50 / 100.";
      endScreen.style.display = "none";
    }

    function showScenarioScreen() {
      startScreen.style.display = "none";
      scenarioContainer.style.display = "block";
      restartBtn.style.display = "inline-block";
      panelTitleLabel.textContent = "Live Scenario";
      panelSubtitleLabel.textContent = "Make a choice and see how your score and class change.";
      endScreen.style.display = "none";
    }

    function showEndScreen() {
      endScreen.style.display = "flex";
      panelTitleLabel.textContent = "Year Complete";
      panelSubtitleLabel.textContent = "See how you did, then try a new year.";
      feedbackText.textContent = "Year finished. Check your report card on the right.";
      feedbackText.classList.remove("error-text");
    }

    function computeFinalRank() {
      const score = state.score;
      const enrollRatio = state.studentsRemaining / state.classSize;

      let rank = "";
      let blurb = "";

      if (score >= 90 && enrollRatio >= 0.95) {
        rank = "ðŸŸ¢ Hillview Legend";
        blurb =
          "Students learned a ton, almost nobody left your class, and parents tell their friends about you in a good way.";
      } else if (score >= 80 && enrollRatio >= 0.9) {
        rank = "ðŸŸ¢ High-Impact Teacher";
        blurb =
          "Youâ€™re demanding, fair, and kids mostly respect you. Some grumbling, but the results speak for themselves.";
      } else if (score >= 70 && enrollRatio >= 0.8) {
        rank = "ðŸŸ¡ Solid & Growing";
        blurb =
          "Lots of things went right. A few decisions cost you, but youâ€™re close to elite with some tweaks.";
      } else if (score >= 60 && enrollRatio >= 0.7) {
        rank = "ðŸŸ¡ Survived the Year";
        blurb =
          "You and the kids made it through. Some wins, some chaos, very realistic middle school energy.";
      } else if (score >= 45 || enrollRatio >= 0.6) {
        rank = "ðŸŸ  Chaotic Neutral Teacher";
        blurb =
          "Memorable for sure. Some students thrived, others transferred. Plenty of stories, mixed outcomes.";
      } else {
        rank = "ðŸ”´ Walking Content for Teacher TikTok";
        blurb =
          "Families, admin, and students would all have opinions. On the bright side, you can instantly replay and try again.";
      }

      return { rank, blurb };
    }

    function renderEndScreen() {
      const { rank, blurb } = computeFinalRank();

      endRank.textContent = rank;
      endMetrics.innerHTML = `
        <span>Final score: <strong>${state.score}</strong> / 100</span>
        <span>Students remaining: <strong>${state.studentsRemaining}</strong> (started with ${state.classSize})</span>
        <span>Scenarios played: <strong>${state.maxRounds}</strong></span>
      `;

      const diffLabel = difficultyLabelFromMultiplier(state.difficultyMultiplier);
      endFootnote.textContent =
        `${blurb} You played on ${diffLabel.replace("Difficulty: ", "").toLowerCase()} with a starting class of ${state.classSize} students.`;

      showEndScreen();
    }

    // ===============================
    // Game lifecycle
    // ===============================
    function resetGame() {
      state.classSize = parseInt(classSizeSelect.value, 10) || 22;
      state.studentsRemaining = state.classSize;
      state.maxStudents = state.classSize;
      state.difficultyMultiplier = computeDifficultyFromClassSize(state.classSize);
      state.round = 0;
      state.score = SCORE_START;
      state.lastScoreDelta = 0;
      state.lastStudentsDelta = 0;
      state.history = [];
      state.shuffledScenarios = shuffleArray(scenarios).slice(0, state.maxRounds);
      state.currentScenario = null;

      classMetaText.textContent = `${state.classSize} students Â· ${difficultyLabelFromMultiplier(
        state.difficultyMultiplier
      ).replace("Difficulty: ", "")}`;
      logContainer.innerHTML = "";
      updateStatsUI();
      showStartScreen();
    }

    function startYear() {
      state.classSize = parseInt(classSizeSelect.value, 10) || 22;
      state.studentsRemaining = state.classSize;
      state.maxStudents = state.classSize;
      state.difficultyMultiplier = computeDifficultyFromClassSize(state.classSize);
      state.round = 0;
      state.score = SCORE_START;
      state.lastScoreDelta = 0;
      state.lastStudentsDelta = 0;
      state.history = [];
      state.shuffledScenarios = shuffleArray(scenarios).slice(0, state.maxRounds);

      classMetaText.textContent = `${state.classSize} students Â· ${difficultyLabelFromMultiplier(
        state.difficultyMultiplier
      ).replace("Difficulty: ", "")}`;

      logContainer.innerHTML = "";
      appendLogEntry({
        round: 0,
        summary: `New year: ${state.classSize} students, score ${SCORE_START} / ${SCORE_MAX}.`
      });

      nextRound();
      showScenarioScreen();
      updateStatsUI();
    }

    function nextRound() {
      state.round += 1;
      if (state.round > state.maxRounds) {
        renderEndScreen();
        return;
      }

      const scenarioIndex = state.round - 1;
      state.currentScenario =
        state.shuffledScenarios[scenarioIndex] || scenarios[scenarioIndex % scenarios.length];

      renderScenario();
      updateStatsUI();
    }

    function handleSubmitChoice() {
      if (!state.currentScenario) return;

      const selectedBtn = document.querySelector(".option-btn.selected");
      const rawCustom = customInput.value.trim();

      let choiceIndex = null;
      let customText = null;

      if (rawCustom) {
        customText = rawCustom;
      } else if (selectedBtn) {
        choiceIndex = parseInt(selectedBtn.dataset.index, 10);
      } else {
        feedbackText.textContent = "Pick an option or write your own response before submitting.";
        feedbackText.classList.add("error-text");
        return;
      }

      const evalResult = evaluateDecision({
        scenario: state.currentScenario,
        choiceIndex,
        customText
      });

      // Update score
      state.score = clamp(state.score + evalResult.scoreDelta, SCORE_MIN, SCORE_MAX);
      state.lastScoreDelta = evalResult.scoreDelta;

      // Update students
      const newStudents = clamp(
        state.studentsRemaining + evalResult.studentsDelta,
        0,
        state.classSize + 8
      );
      state.lastStudentsDelta = newStudents - state.studentsRemaining;
      state.studentsRemaining = newStudents;
      state.maxStudents = Math.max(state.maxStudents, state.studentsRemaining);

      const commentary = buildCommentary(
        evalResult.scoreDelta,
        evalResult.explanation,
        evalResult.catastrophic
      );

      const summary = `Score ${evalResult.scoreDelta >= 0 ? "+" : ""}${evalResult.scoreDelta}, ` +
        `${state.lastStudentsDelta >= 0 ? "+" : ""}${state.lastStudentsDelta} students. ` +
        commentary;

      state.history.push({
        round: state.round,
        scenarioId: state.currentScenario.id,
        choiceIndex,
        usedCustom: !!customText,
        scoreDelta: evalResult.scoreDelta,
        studentsDelta: state.lastStudentsDelta,
        commentary
      });

      appendLogEntry({ round: state.round, summary });
      feedbackText.textContent = summary;
      feedbackText.classList.remove("error-text");

      updateStatsUI();

      setTimeout(() => {
        if (state.round >= state.maxRounds) {
          renderEndScreen();
        } else {
          nextRound();
        }
      }, 1100);
    }

    // ===============================
    // Events
    // ===============================
    startBtn.addEventListener("click", startYear);
    restartBtn.addEventListener("click", resetGame);
    submitBtn.addEventListener("click", handleSubmitChoice);
    playAgainBtn.addEventListener("click", startYear);

    classSizeSelect.addEventListener("change", () => {
      const previewSize = parseInt(classSizeSelect.value, 10) || 22;
      const previewDiff = computeDifficultyFromClassSize(previewSize);
      classMetaText.textContent = `${previewSize} students Â· ${difficultyLabelFromMultiplier(previewDiff)
        .replace("Difficulty: ", "")}`;
    });

    // Init
    resetGame();
  </script>
</body>
</html>
